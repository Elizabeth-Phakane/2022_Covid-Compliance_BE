const express =require('express');
const bodyparser=require('body-parser');
const cors = require('cors');
const mysql=require('mysql');
const router = express.Router();
const app=express();
module.exports = router;






// const Connection = require('mysql2/typings/mysql/lib/Connection');
// const db=mysql.createConnection({host:'localhost',user:'root',password:'',database:'covid_compliance',port:'3306'});


const database=require('./database');

router.post('/forgot', (req, res) =>{

    let Email = req.body.Email ;
    let sql, link;

    sql = `SELECT Email FROM user WHERE Email = '${Email}' `;

    database.query(sql,(err,result) =>{
          if(err)
        {
            console.log("SQL error");
            

            return;
        }
        
        if(result.length >0)
        {
            console.log("User found");

            res.send("User found");

            link = "http://localhost3306:/resetPassword";

            var nodemailer = require('nodemailer');
            let transporter = nodemailer.createTransport({
            service:'gmail',
            host: 'smtp.gmail.com',
            port:'587',
            auth:{
                user: 'tshwanevirtualhackathon@gmail.com',
                pass: 'Tvh@0152'
            },
            secureConnection: 'false',
            tls: {
                ciphers: 'SSLv3',
                rejectUnauthorized: false
            }
            }); 
                                 
            message ={

            from:'tshwanevirtualhackathon@gmail.com',
            to:JSON.stringify(email),
            subject:'No reply :TVH Application',
            text: ( 'You Have successfully applied  for TVH ' 
            +'\n participant Name : '+ First_name
            +'\n participant Surname     : ' + Last_name
            +'\n click here to reset password     : ' + link 
            +'\n\n\n If your application is succesfull you will hear from us,' 
            +'\n if not please apply next time')
            };

            transporter.sendMail(message,function(err, info) {
                if (err) {
                     console.log(err)
                } else {
                     console.log(info);
                }   
            });


          return;
    

         }
        else{

            console.log("User not found ");
            res.send("User not found ");

            return;
        }

    });

});

router.put("/reset", (req, res) =>{

    let email, password = req.body.email ;
    let sql1, sql2;

    sql1 = `SELECT Email FROM user WHERE Email == ${email}`;

    database.query(sql1,(err,result) =>{

        if(err)
        {
            console.log(err);
        }
        
        if(result.length > 0)
        {
            console.log("User found");



            sql2 = `UPDATE user  SET password = ${password} WHERE Email == ${email}`;

            db.query(sql2,(err,result) =>{

                if(err)
                {
                    console.log(err);
                    res.send("There was an error");
                }

                if(result.length > 0)
                {

                    res.send("Your password was successfully updated");
                }

            });


        }
        else{

            console.log("User not found ");
            res.send("User not found ");
        }

    });

});




        